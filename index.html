<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>工人扫码 - Angelina</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 5vw;
      margin: 0;
      background: #f9f9f9;
    }
    h2 {
      color: #2c3e50;
      font-size: 5vw;
      margin: 2vh 0;
    }
    #reader {
      margin: 0 auto;
      width: 90vw;
      max-width: 400px;
      aspect-ratio: 1;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    input#scannerInput {
      margin-top: 20px;
      font-size: 18px;
      padding: 10px;
      width: 80%;
      max-width: 400px;
      text-align: center;
    }
    #warningMsg {
      margin-top: 10px;
      font-size: 14px;
      color: #5dade2; /* 低亮水蓝色 */
      display: none;
    }
  </style>
</head>
<body>
  <h2>Welcome Angelina (A0001)</h2>
  <div id="reader"></div>

  <!-- 给电脑扫码枪用的输入框 -->
  <input type="text" id="scannerInput" placeholder="请扫描图纸上的 QR Code" autofocus>
  <div id="warningMsg">Bro,冷静! 不要一直重复扫描自己的QR Code。</div>

  <script>
    const BLOCKED_URL = "https://hl-steel-industries-sdn-bhd.github.io/Test/";
    const warning = document.getElementById("warningMsg");

    const html5QrCode = new Html5Qrcode("reader");
    let scanningLocked = false; // 一旦为 true，就忽略所有后续解码，避免 race / 重复触发

    // 统一处理扫码结果
    async function handleScan(rawText, fromCamera = false) {
      if (!rawText) return;
      const text = String(rawText).trim();

      // 如果已经上锁，直接忽略
      if (scanningLocked) return;

      // 如果是被阻止的 URL —— 永远不跳转，只提示并停止相机
      if (text === BLOCKED_URL) {
        scanningLocked = true;
        warning.style.display = "block";

        // 尝试优雅停止并清除相机（防止后续帧继续触发）
        try {
          await html5QrCode.stop();
        } catch (e) {
          // stop 可能会拒绝或抛错误，尝试 clear
        }
        try { html5QrCode.clear(); } catch (e) {}
        return;
      }

      // 普通 URL：跳转（相机场景先停止再跳）
      if (text.startsWith("http://") || text.startsWith("https://")) {
        scanningLocked = true; // 上锁，保证只触发一次跳转
        if (fromCamera) {
          try {
            await html5QrCode.stop();
          } catch (e) {
            // ignore
          }
          try { html5QrCode.clear(); } catch (e) {}
          // 最后再跳
          window.location.href = text;
        } else {
          // 扫码枪直接跳
          window.location.href = text;
        }
        return;
      }

      // 非 URL 内容
      alert("无效的 QR 内容: " + text);
    }

    // 启动摄像头扫码
    function startScanning() {
      // 如果前面已经上锁（例如页面刚加载时因为某些行为），不再启动
      if (scanningLocked) return;

      html5QrCode.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: function(viewfinderWidth, viewfinderHeight) {
            let minEdge = Math.min(viewfinderWidth, viewfinderHeight);
            return { width: Math.floor(minEdge * 0.8), height: Math.floor(minEdge * 0.8) };
          }
        },
        (decodedText) => handleScan(decodedText, true),
        (error) => { /* ignore decode failures */ }
      ).catch(err => {
        console.error("扫描启动失败:", err);
      });
    }
    startScanning();

    // 电脑扫码枪逻辑（输入框监听回车）
    const input = document.getElementById("scannerInput");
    input.focus();

    // 失焦自动回聚焦（保持扫码枪输入时不需要点）
    input.addEventListener("blur", () => {
      setTimeout(() => input.focus(), 100);
    });

    // 回车后处理
    input.addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        const text = input.value.trim();
        input.value = ""; // 立即清空，避免重复触发
        handleScan(text, false);
      }
    });
  </script>
</body>
</html>








